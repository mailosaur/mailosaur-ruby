name: Publish

on:
  release:
    types: [created]

permissions:
  contents: read

jobs:
  publish:
    runs-on: ${{ vars.LINUX }}
    timeout-minutes: 10

    steps:
    - name: Checkout source code
        uses: actions/checkout@v4
    - name: Checkout custom actions
      uses: actions/checkout@v4
      with:
        repository: mailosaur/actions
        token: ${{ secrets.CUSTOM_ACTIONS_TOKEN }}
        path: .github/actions
    - name: Set up Ruby
      uses: ruby/setup-ruby@v1
      with:
        ruby-version: ${{ vars.RUBY_VERSION }}
    - name: Version
      run: |
        version=`git describe --abbrev=0 --tags` &&	
        sed -i s/\[0-9]\.\[0-9]\.\[0-9]/$version/ lib/Mailosaur/version.rb
    - name: Publish to RubyGems
      run: |
        mkdir -p $HOME/.gem
        touch $HOME/.gem/credentials
        chmod 0600 $HOME/.gem/credentials
        printf -- "---\n:rubygems_api_key: ${GEM_HOST_API_KEY}\n" > $HOME/.gem/credentials
        gem build *.gemspec
        gem push *.gem
      env:
        GEM_HOST_API_KEY: ${{ secrets.RUBYGEMS_AUTH_TOKEN }}
    - name: Send notifications
      if: ${{ always() }}
      uses: ./.github/actions/notify
      with:
        webhook-url: ${{ secrets.NOTIFICATION_URL }}
